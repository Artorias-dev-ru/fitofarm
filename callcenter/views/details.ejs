<!DOCTYPE html>
<html>
<head>
    <title>Детали диалога</title>
    <link rel="stylesheet" href="<%= baseUrl %>/fonts.css">
    <style>
        :root { --card-shadow: 0 4px 12px rgba(0,0,0,0.05); --orange-accent: #E86B35; }
        body { margin: 0; padding: 0; background: #E5E5E5; display: flex; font-family: 'Manrope', sans-serif; }
        .main-content { flex: 1; margin-left: 260px; padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; transition: margin-left 0.3s ease; }
        .top-nav { display: flex; background: white; padding: 15px 30px; border-radius: 15px; margin-bottom: 15px; box-shadow: var(--card-shadow); align-items: center; min-height: 90px; }
        .header-date-range { display: flex; flex-direction: column; font-size: 22px; font-weight: 500; color: #333; line-height: 1.2; padding-right: 30px; border-right: 1px solid #ddd; }
        .header-date-range div span { color: #999; font-size: 16px; margin-right: 10px; font-weight: 400; }
        .header-filters { flex: 1; padding-left: 30px; display: flex; flex-direction: column; gap: 8px; }
        .filter-activity { position: relative; font-size: 14px; color: #333; font-weight: 500; display: flex; align-items: center; gap: 12px; }
        .activity-pill-dropdown { background: #f0f0f0; padding: 4px 14px; border-radius: 8px; color: #555; font-weight: 600; cursor: pointer; }
        .dropdown-menu-activity { display: none; position: absolute; top: 100%; left: 100px; background: #f0f0f0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 100; min-width: 200px; margin-top: 5px; overflow: hidden; }
        .dropdown-menu-activity.show { display: block; }
        .dropdown-item-act { padding: 10px 15px; font-size: 14px; color: #333; cursor: pointer; text-align: center; font-weight: 500; }
        .dropdown-item-act:hover { background: #e0e0e0; }
        .filter-status { font-size: 14px; color: #aaa; font-weight: 500; }
        .filter-status span { cursor: pointer; transition: 0.2s; padding: 2px 8px; border-radius: 4px; }
        .filter-status .active-status { background: #f0f0f0; color: #333; font-weight: 600; }
        .header-right { display: flex; flex-direction: column; align-items: flex-end; justify-content: space-between; height: 75px; }
        .header-avatar { width: 34px; height: 34px; border-radius: 50%; object-fit: cover; }
        .layout-grid { display: grid; grid-template-columns: 280px 1fr 400px; gap: 15px; flex: 1; overflow: hidden; }
        .sidebar-calls { overflow-y: auto; display: flex; flex-direction: column; padding-right: 10px; scroll-behavior: smooth; font-family: 'Myriad Pro', sans-serif; }
        .date-card { position: sticky; top: 0; z-index: 10; background: white; border: 1px solid #ccc; border-radius: 0; padding: 12px; text-align: center; cursor: pointer; box-shadow: var(--card-shadow); margin-bottom: 8px; width: 100%; }
        .date-card.active { border-color: #333; border-width: 2px; }
        .date-val { display: block; font-size: 20px; font-weight: 800; color: #333; line-height: 1.1; }
        .date-count { display: block; font-size: 11px; font-weight: 700; color: #333; margin-top: 4px; }
        .dialog-stack { display: none; flex-direction: column; gap: 6px; margin: 0 0 15px 0; }
        .dialog-stack.expanded { display: flex; }
        .dialog-box { background: #929292; border-radius: 0; padding: 12px 15px; color: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center; text-decoration: none; border: 1px solid transparent; width: 70%; }
        .dialog-box.current { background: white; border: 1px solid #ccc; color: #333; }
        .dialog-name { font-size: 16px; font-weight: 600; }
        .dialog-meta { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .dialog-time-wrap { font-size: 11px; font-weight: 800; display: flex; align-items: center; gap: 6px; }
        .error-label { color: #EB5757; font-size: 10px; font-weight: 900; margin-top: 1px; text-transform: lowercase; }
        .center-pane { background: white; border-radius: 15px; display: flex; padding: 30px; gap: 30px; overflow-y: auto; box-shadow: var(--card-shadow); border: 1px solid #eee; }
        .dialog-col { flex: 1; font-size: 14px; line-height: 1.8; color: #333; overflow-wrap: break-word; word-break: break-word; }
        .dialog-header-row { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; }
        .violation-tag { font-size: 12px; font-weight: 700; color: #EB5757; text-transform: lowercase; }
        .right-pane { display: flex; flex-direction: column; gap: 15px; }
        .audio-card { background: white; border-radius: 15px; padding: 25px; box-shadow: var(--card-shadow); border: 1px solid #eee; display: flex; flex-direction: column; gap: 15px; }
        .player-seeker-wrap { width: 100%; height: 4px; background: #eee; border-radius: 2px; position: relative; cursor: pointer; }
        .player-seeker-fill { height: 100%; background: #929292; border-radius: 2px; width: 0%; pointer-events: none; }
        .player-seeker-thumb { width: 12px; height: 12px; background: #929292; border-radius: 50%; position: absolute; top: -4px; margin-left: -6px; pointer-events: none; }
        .player-controls { display: flex; align-items: center; gap: 15px; }
        .play-btn { width: 44px; height: 44px; background: #929292; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }
        .play-btn svg { width: 24px; height: 24px; fill: white; }
        .player-timer { font-size: 16px; font-weight: 700; flex-grow: 1; }
        .volume-section { display: flex; align-items: center; gap: 10px; }
        .vol-btn svg { width: 18px; height: 18px; fill: #999; }
        .vol-slider { width: 60px; height: 4px; background: #eee; border-radius: 2px; position: relative; cursor: pointer; }
        .vol-fill { height: 100%; background: #929292; border-radius: 2px; width: 80%; }
        .vol-thumb { width: 10px; height: 10px; background: #929292; border-radius: 50%; position: absolute; top: -3px; left: 80%; margin-left: -5px; }
        .download-btn svg { width: 20px; height: 20px; fill: #999; cursor: pointer; }
        .tabs-card { background: white; border-radius: 15px; flex: 1; padding: 0; overflow: hidden; display: flex; flex-direction: column; box-shadow: var(--card-shadow); border: 1px solid #eee; }
        .tab-headers { display: flex; border-bottom: 1px solid #f0f0f0; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: #f8f8f8; cursor: pointer; font-size: 13px; font-weight: 700; color: #888; border-right: 1px solid #eee; }
        .tab-btn.active { background: var(--orange-accent); color: white; }
        .tab-content { padding: 25px; font-size: 14px; flex: 1; display: none; overflow-wrap: break-word; word-break: break-word; }
        .tab-content.active { display: block; }
        .info-box { border: 1px solid var(--orange-accent); border-radius: 12px; padding: 12px; margin-bottom: 10px; text-align: center; color: #333; font-weight: 700; font-size: 14px; }
        .modal-result-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; align-items: center; justify-content: center; }
        .modal-result-box { background: #E5E5E5; padding: 25px; border-radius: 12px; width: 600px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-result-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; color: #333; }
        .modal-result-white-bg { background: white; padding: 30px; border-radius: 12px; margin-bottom: 20px; }
        .status-option { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; cursor: pointer; font-size: 18px; font-weight: 600; color: #000; }
        .result-textarea { width: 100%; border: none; font-size: 16px; outline: none; resize: none; min-height: 100px; font-family: inherit; }
        .btn-cancel-res { background: #929292; color: white; border: none; padding: 10px 30px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 16px; }
        .btn-save-res { background: var(--orange-accent); color: white; border: none; padding: 10px 30px; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 16px; }
        .note-block { background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 12px; margin-top: 10px; position: relative; }
        .note-meta { display: flex; justify-content: space-between; font-size: 11px; color: #999; margin-bottom: 5px; font-weight: 600; padding-right: 50px; }
        .note-text { font-size: 13px; color: #333; line-height: 1.4; white-space: pre-wrap; overflow-wrap: break-word; word-break: break-word; }
        .note-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 8px; }
        .note-action-btn { cursor: pointer; opacity: 0.5; transition: 0.2s; background: none; border: none; padding: 0; }
        .note-action-btn:hover { opacity: 1; }
        .note-action-btn svg { width: 14px; height: 14px; }
        .modal-note-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 3000; align-items: center; justify-content: center; }
        .modal-note-box { background: white; padding: 25px; border-radius: 12px; width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .status-отработано { color: #27ae60 !important; }
        .status-неотработано { color: #e74c3c !important; }
        .status-нераспознано { color: #95a5a6 !important; }
        .status-безстатуса { color: #aaa !important; }
        .unread-dot { width: 15px; height: 15px; background-color: var(--orange-accent); border-radius: 50%; display: inline-block; flex-shrink: 0; margin: 5px 5px 13px 5px; transition: background-color 0.2s; }
        .unread-dot.read { background-color: transparent; }
        .date-card-header { display: flex; align-items: center; justify-content: center; gap: 5px; }
        .date-card-wrapper { display: flex; justify-content: end; align-items: center; }
    </style>
</head>
<body>
    <%- include('sidebar') %>
    <div class="main-content" id="mainContent">
        <div class="top-nav">
            <div class="header-date-range"><div><span>с</span>10.01.26</div><div><span>по</span>23.01.26</div></div>
            <div class="header-filters">
                <div class="filter-activity">Активность: <div class="activity-pill-dropdown" onclick="toggleActivityDropdown(event)"><%= currentActivityFilter %></div>
                    <div id="activityDropdown" class="dropdown-menu-activity">
                        <div class="dropdown-item-act <%= currentActivityFilter === 'все звонки' ? 'active' : '' %>" onclick="filterByActivity('все звонки')">все звонки</div>
                        <div class="dropdown-item-act <%= currentActivityFilter === 'грубая ошибка' ? 'active' : '' %>" onclick="filterByActivity('грубая ошибка')">грубая ошибка</div>
                        <div class="dropdown-item-act <%= currentActivityFilter === 'отсутствие приветствия' ? 'active' : '' %>" onclick="filterByActivity('отсутствие приветствия')">отсутствие приветствия</div>
                        <div class="dropdown-item-act <%= currentActivityFilter === 'агрессия' ? 'active' : '' %>" onclick="filterByActivity('агрессия')">агрессия</div>
                        <div class="dropdown-item-act" onclick="filterByActivity('вежливость')">вежливость</div>
                        <div class="dropdown-item-act" onclick="filterByActivity('дружелюбие')">дружелюбие</div>
                        <div class="dropdown-item-act" onclick="filterByActivity('манипуляция')">манипуляция</div>
                    </div>
                </div>
                <div class="filter-status">
                    <span class="<%= currentStatusFilter === 'отработано' ? 'active-status' : '' %>" onclick="filterByStatus('отработано')">отработано</span> / 
                    <span class="<%= currentStatusFilter === 'не отработано' ? 'active-status' : '' %>" onclick="filterByStatus('не отработано')">не отработано</span> / 
                    <span class="<%= currentStatusFilter === 'нераспознано' ? 'active-status' : '' %>" onclick="filterByStatus('нераспознано')">нераспознано</span> / 
                    <span class="<%= currentStatusFilter === 'без статуса' ? 'active-status' : '' %>" onclick="filterByStatus('без статуса')">без статуса</span>
                </div>
            </div>
            <div class="header-right"><img src="<%= user && user.avatar ? user.avatar : baseUrl + '/public/avatar1.png' %>" class="header-avatar"></div>
        </div>
        <div class="layout-grid">
            <div class="sidebar-calls">
                <% sidebarDates.forEach(item => { %>
                    <% const isDateActive = item.date === currentCall.date; %>
                    <div class="date-group">
                        <div class="date-card-wrapper">
                            <div class="unread-dot <%= item.unreadCount > 0 ? '' : 'read' %>" 
                                 title="<%= item.unreadCount > 0 ? 'Есть непрочитанные' : '' %>"></div>
                            
                            <div class="date-card <%= isDateActive ? 'active' : '' %>" onclick="toggleDate(this, '<%= item.date %>')">
                                <div class="date-card-header">
                                    <span class="date-val"><%= moment(item.date).format('DD.MM.YY') %></span>
                                </div>
                                <span class="date-count">Диалогов <%= item.count %></span>
                            </div>
                        </div>
                        
                        <div class="dialog-stack <%= isDateActive ? 'expanded' : '' %>">
                            <% if (isDateActive) { %>
                                <% currentDayCalls.forEach((call, idx) => { %>
                                    <% 
                                       const isError = (call.rudeness > 0.5 || call.said_hello === false); 
                                       const isUnread = !readIds.includes(call.id);
                                    %>
                                    <div class="date-card-wrapper">
                                        <div class="unread-dot <%= isUnread ? '' : 'read' %>"></div>
                                        
                                        <a id="dialog-<%= call.id %>" 
                                           href="<%= baseUrl %>/details/<%= call.id %>?status=<%= currentStatusFilter %>&activity=<%= currentActivityFilter %>" 
                                           class="dialog-box <%= call.id == currentCall.id ? 'current' : '' %>">
                                            
                                            <div style="display: flex; align-items: center;">
                                                <span class="dialog-name">Диалог <%= idx + 1 %></span>
                                            </div>
                                    
                                            <div class="dialog-meta">
                                                <div class="dialog-time-wrap">
                                                    <%= Math.floor(call.duration/60) %>:<%= String(Math.floor(call.duration%60)).padStart(2, '0') %>
                                                </div>
                                                <% if(isError) { %><span class="error-label">ошибка!</span><% } %>
                                            </div>
                                        </a>
                                    </div>
                                <% }) %>
                            <% } %>
                        </div>
                    </div>
                <% }) %>
            </div>
            <div class="center-pane">
                 <div class="dialog-col">
                    <div class="dialog-header-row"><strong style="font-size: 18px; color: #000;">Диалог <%= currentCall.id %></strong><% if (currentCall.rudeness > 0.5) { %><span class="violation-tag">#агрессия</span><% } %><% if (currentCall.said_hello === false) { %><span class="violation-tag">#отсутствие приветствия</span><% } %></div><% if (currentCall.politeness < 0.5) { %><span class="violation-tag">#отсутствие вежливости</span><% } %><% if (currentCall.friendliness < 0.5) { %><span class="violation-tag">#отсутствие дружелюбия</span><% } %><% if (currentCall.manipulativeness > 0.5) { %><span class="violation-tag">#манипуляция</span><% } %>
                    <div style="white-space: pre-wrap;"><%- currentCall.text ? currentCall.text : '' %></div>
                </div>
            </div>
            <div class="right-pane">
                <div class="audio-card">
                    <div class="player-seeker-wrap" id="seekerWrap">
                        <div class="player-seeker-fill" id="seekerFill"></div>
                        <div class="player-seeker-thumb" id="seekerThumb"></div>
                    </div>
                    <div class="player-controls">
                        <button class="play-btn" id="masterPlay">
                            <svg id="svgPlay" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            <svg id="svgPause" style="display:none" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                        </button>
                        <div class="player-timer" id="playerTimer">0:00 - 0:00</div>
                        <div class="volume-section">
                            <div class="vol-btn"><svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg></div>
                            <div class="vol-slider" id="volSlider"><div class="vol-fill" id="volFill"></div><div class="vol-thumb" id="volThumb"></div></div>
                        </div>
                        <a href="<%= baseUrl %>/api/audio/<%= currentCall.id %>" download class="download-btn"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></a>
                  </div>
                </div>
                <div class="tabs-card">
                    <div class="tab-headers">
                        <button class="tab-btn active" onclick="switchTab(event, 'brief')">Краткий отчет</button>
                        <button class="tab-btn" onclick="switchTab(event, 'notes')">Заметки</button>
                        <button class="tab-btn" onclick="switchTab(event, 'result')">Результат</button>
                    </div>
                    <div id="brief" class="tab-content active">
                        <div class="info-box"><%= moment(currentCall.date).format('DD.MM.YY') %> / <%= currentCall.time %></div>
                        <% let dl = 'Внутренний'; if(currentCall.direction === 'incoming') dl = 'Входящий'; if(currentCall.direction === 'outgoing') dl = 'Исходящий'; %>
                        <div class="info-box">Тип: <%= dl %></div><div class="info-box">Тел: <%= currentCall.phoneNumber || '—' %></div>
                        <div style="margin-top:25px"><strong style="display:block; margin-bottom:12px; font-size:16px;">Сводка:</strong><p style="color: #444; line-height: 1.6; margin: 0;"><%= currentCall.summary || 'Нет данных' %></p></div>
                    </div>
                    <div id="notes" class="tab-content">
                        <div style="border: 2px solid #ddd; padding: 15px; border-radius: 12px; background: #fff;">
                            <strong style="display:block; margin-bottom:12px; font-size:16px;">Добавить заметку:</strong>
                            <textarea id="noteInput" style="width:calc(100%-20px); height:80px; border:1px solid #ddd; border-radius:8px; padding:10px; margin-bottom:10px; font-family:inherit; resize:none;" placeholder="Введите текст..."></textarea>
                            <button onclick="saveNote()" style="background: var(--orange-accent); color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:700; width: 100%;">Сохранить</button>
                        </div>
                        <div style="margin-top:20px">
                            <% if (callNotes && callNotes.length > 0) { %>
                                <% callNotes.forEach(note => { %>
                                    <div class="note-block" id="note-<%= note.id %>">
                                        <div class="note-meta">
                                            <span><%= note.User ? note.User.fullName : 'Пользователь' %></span>
                                            <span><%= moment(note.createdAt).format('DD.MM.YY HH:mm') %></span>
                                        </div>
                                        <div class="note-text"><%= note.content %></div>
                                        <div class="note-actions">
                                            <button class="note-action-btn" onclick="openEditNoteModal('<%= note.id %>', `<%= note.content.replace(/`/g, '\\`') %>`)">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                            </button>
                                            <button class="note-action-btn" onclick="confirmDeleteNote('<%= note.id %>')">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="#e74c3c" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                            </button>
                                        </div>
                                    </div>
                                <% }) %>
                            <% } else { %>
                                <p style="text-align:center; color:#999; margin-top: 20px;">Заметок пока нет</p>
                            <% } %>
                        </div>
                    </div>
                    <div id="modalEditNote" class="modal-note-overlay">
                        <div class="modal-note-box">
                            <h3 style="margin-top:0">Редактировать заметку</h3>
                            <textarea id="editNoteText" style="width:100%; height:120px; border:1px solid #ddd; border-radius:8px; padding:10px; margin-bottom:15px; font-family:inherit; resize:none;"></textarea>
                            <input type="hidden" id="editNoteId">
                            <div style="display:flex; justify-content:flex-end; gap:10px">
                                <button onclick="closeEditNoteModal()" style="background:#eee; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">Отмена</button>
                                <button onclick="updateNote()" style="background:var(--orange-accent); color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:700;">Сохранить изменения</button>
                            </div>
                        </div>
                    </div>
                    <div id="modalDeleteNote" class="modal-note-overlay">
                        <div class="modal-note-box" style="width:350px; text-align:center;">
                            <h3 style="margin-top:0">Удалить заметку?</h3>
                            <p style="color:#666; font-size:14px;">Это действие нельзя будет отменить.</p>
                            <input type="hidden" id="deleteNoteId">
                            <div style="display:flex; justify-content:center; gap:10px; margin-top:20px">
                                <button onclick="closeDeleteNoteModal()" style="background:#eee; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">Отмена</button>
                                <button onclick="deleteNote()" style="background:#e74c3c; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:700;">Удалить</button>
                            </div>
                        </div>
                    </div>
                    <div id="result" class="tab-content">
                        <div class="info-box">Статус: <%= currentCall.status || 'без статуса' %></div>
                        <div style="margin-top:25px"><strong style="display:block; margin-bottom:12px; font-size:16px;">Результат:</strong><p id="displayManualResult" style="color: #444; line-height: 1.6; margin: 0;"><%= currentCall.manualResult || 'Нет результата' %></p></div>
                        <button onclick="openResultModal()" style="margin-top:20px; background: #333; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:700;">Изменить</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="modalResult" class="modal-result-overlay"><div class="modal-result-box"><div class="modal-result-title">Результат диалога</div><div class="modal-result-white-bg"><label class="status-option"><input type="radio" name="resStatus" value="отработано" <%= currentCall.status === 'отработано' ? 'checked' : '' %>> Отработано</label><label class="status-option"><input type="radio" name="resStatus" value="не отработано" <%= currentCall.status === 'не отработано' ? 'checked' : '' %>> Неотработано</label><label class="status-option"><input type="radio" name="resStatus" value="нераспознано" <%= currentCall.status === 'нераспознано' ? 'checked' : '' %>> Нераспознано</label><label class="status-option"><input type="radio" name="resStatus" value="без статуса" <%= currentCall.status === 'без статуса' ? 'checked' : '' %>> Без статуса</label><div style="border-top:1px solid #eee; margin-top:20px; padding-top:20px"><div style="font-size:18px; color:#999; margin-bottom:10px">Результат</div><textarea id="manualResultText" class="result-textarea" placeholder="Напишите результат..."><%= currentCall.manualResult || '' %></textarea></div></div><div style="display:flex; justify-content:space-between; align-items:center"><div style="color:#888; font-size:14px">* <%= currentCall.Processor ? currentCall.Processor.fullName : user.fullName %></div><div style="display:flex; gap:10px"><button class="btn-cancel-res" onclick="closeResultModal()">Отмена</button><button class="btn-save-res" onclick="saveDialogResult()">Сохранить</button></div></div></div></div>
    <script>
        const audio = new Audio('<%= baseUrl %>/api/audio/<%= currentCall.id %>');
        const playBtn = document.getElementById('masterPlay');
        const svgP = document.getElementById('svgPlay');
        const svgS = document.getElementById('svgPause');
        const timer = document.getElementById('playerTimer');
        const sWrap = document.getElementById('seekerWrap');
        const sFill = document.getElementById('seekerFill');
        const sThumb = document.getElementById('seekerThumb');
        const vS = document.getElementById('volSlider');
        const vF = document.getElementById('volFill');
        const vT = document.getElementById('volThumb');
        const fmt = (s) => { if(isNaN(s)) return '0:00'; let m=Math.floor(s/60), sec=Math.floor(s%60); return `${m}:${sec<10?'0':''}${sec}`; };
        playBtn.onclick = () => { if(audio.paused) audio.play(); else audio.pause(); };
        audio.onplay = () => { svgP.style.display='none'; svgS.style.display='block'; };
        audio.onpause = () => { svgP.style.display='block'; svgS.style.display='none'; };
        audio.ontimeupdate = () => {
            const p = (audio.currentTime / audio.duration) * 100;
            sFill.style.width = p+'%'; sThumb.style.left = p+'%';
            timer.innerText = `${fmt(audio.currentTime)} - ${fmt(audio.duration)}`;
        };
        audio.onloadedmetadata = () => { timer.innerText = `0:00 - ${fmt(audio.duration)}`; };
        sWrap.onclick = (e) => { const r=sWrap.getBoundingClientRect(); const p=(e.clientX-r.left)/r.width;
        audio.currentTime = p*audio.duration; };
        vS.onclick = (e) => { const r=vS.getBoundingClientRect(); let p=(e.clientX-r.left)/r.width; if(p<0)p=0; if(p>1)p=1; audio.volume=p; vF.style.width=p*100+'%'; vT.style.left=p*100+'%'; };
        function switchTab(evt, name) { 
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(name).classList.add('active'); 
            if (evt) evt.currentTarget.classList.add('active');
            else document.querySelector(`[onclick*="'${name}'"]`).classList.add('active');
            const url = new URL(window.location);
            url.searchParams.set('tab', name);
            window.history.replaceState({}, '', url);
        }
        async function saveNote() {
            const content = document.getElementById('noteInput').value;
            if(!content.trim()) return;
            const res = await fetch('<%= baseUrl %>/api/notes', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ callId: '<%= currentCall.id %>', content }) 
            });
            if (res.ok) window.location.reload();
        }
        function openEditNoteModal(id, content) {
            document.getElementById('editNoteId').value = id;
            document.getElementById('editNoteText').value = content;
            document.getElementById('modalEditNote').style.display = 'flex';
        }
        function closeEditNoteModal() { document.getElementById('modalEditNote').style.display = 'none'; }
        async function updateNote() {
            const id = document.getElementById('editNoteId').value;
            const content = document.getElementById('editNoteText').value;
            const res = await fetch(`<%= baseUrl %>/api/notes/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });
            if (res.ok) window.location.reload();
        }
        function confirmDeleteNote(id) {
            document.getElementById('deleteNoteId').value = id;
            document.getElementById('modalDeleteNote').style.display = 'flex';
        }
        function closeDeleteNoteModal() { document.getElementById('modalDeleteNote').style.display = 'none'; }
        async function deleteNote() {
            const id = document.getElementById('deleteNoteId').value;
            const res = await fetch(`<%= baseUrl %>/api/notes/${id}`, { method: 'DELETE' });
            if (res.ok) window.location.reload();
        }
        function openResultModal() { document.getElementById('modalResult').style.display='flex'; }
        function closeResultModal() { document.getElementById('modalResult').style.display='none'; }
        async function saveDialogResult() {
            const res = await fetch('<%= baseUrl %>/api/calls/<%= currentCall.id %>/result', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: document.querySelector('input[name="resStatus"]:checked').value, manualResult: document.getElementById('manualResultText').value }) });
            if (res.ok) window.location.reload();
        }
        document.addEventListener('DOMContentLoaded', () => {
            const cur = document.querySelector('.dialog-box.current');
            if (cur) cur.scrollIntoView({ behavior: 'auto', block: 'center' });
            const urlParams = new URLSearchParams(window.location.search);
            const activeTab = urlParams.get('tab') || 'brief';
            switchTab(null, activeTab);
        });
        function toggleDate(el, dateStr) {
            const stack = el.nextElementSibling;
            if (stack.classList.contains('expanded')) {
                stack.classList.remove('expanded');
                el.classList.remove('active');
            } else {
                const u = new URL(window.location.href);
                const s = u.searchParams.get('status') || 'all';
                const a = u.searchParams.get('activity') || 'все звонки';
                const t = u.searchParams.get('tab') || 'brief';
                window.location.href = '<%= baseUrl %>/details/' + dateStr + '_redir?date=' + dateStr + '&status=' + s + '&activity=' + a + '&tab=' + t;
            }
        }
        function toggleActivityDropdown(e) { e.stopPropagation();
        document.getElementById("activityDropdown").classList.toggle("show"); }
        window.onclick = (e) => { if (!e.target.matches('.activity-pill-dropdown')) { const d = document.getElementById("activityDropdown");
        if(d) d.classList.remove('show'); } };
        function filterByStatus(s) { 
            const u = new URL(window.location);
            if (u.searchParams.get('status') === s) u.searchParams.delete('status'); 
            else u.searchParams.set('status', s);
            window.location.href = u.href;
        }
        function filterByActivity(a) { const u = new URL(window.location);
        if (a === 'все звонки') u.searchParams.delete('activity'); else u.searchParams.set('activity', a); window.location.href = u.href; }
    </script>
</body>
</html>