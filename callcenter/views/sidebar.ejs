<style>
    :root { --sidebar-bg: #e0e0e0; --sidebar-width: 260px; --sidebar-collapsed-width: 80px; }
    .sidebar { width: var(--sidebar-width); background-color: var(--sidebar-bg); height: 100vh; position: fixed; left: 0; top: 0; display: flex; flex-direction: column; padding: 20px 0; transition: all 0.3s ease; z-index: 1000; font-family: 'Myriad Pro', sans-serif !important; }
    .sidebar.collapsed { width: var(--sidebar-collapsed-width); }
    .sidebar-header { padding: 0 25px 30px 25px; }
    .sidebar-logo { width: 50px; height: 50px; object-fit: contain; }
    .sidebar-menu { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
    .sidebar-item { display: flex; align-items: center; padding: 12px 25px; text-decoration: none; color: #333; transition: background 0.2s; cursor: pointer; }
    .sidebar-item:hover { background-color: rgba(0, 0, 0, 0.05); }
    .sidebar-icon { width: 24px; height: 24px; margin-right: 15px; flex-shrink: 0; opacity: 0.7; }
    .sidebar-text { font-size: 15px; font-weight: 500; white-space: nowrap; }
    .sidebar.collapsed .sidebar-text, .sidebar.collapsed .user-name { display: none; }
    .sidebar.collapsed .sidebar-icon { margin-right: 0; }
    .sidebar-footer { padding: 20px 0; border-top: 1px solid rgba(0, 0, 0, 0.05); }
    .user-profile { display: flex; align-items: center; padding: 8px 25px; }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 12px; background-color: #ccc; flex-shrink: 0; object-fit: cover; }
    .user-name { font-size: 14px; color: #555; white-space: nowrap; }
    .sync-btn { color: #E86B35 !important; font-weight: 700 !important; }
</style>
<div class="sidebar" id="sidebar">
    <div class="sidebar-header"><a href="<%= baseUrl %>/"><img src="<%= baseUrl %>/public/logo.svg" class="sidebar-logo"></a></div>
    <ul class="sidebar-menu">
        <li><div class="sidebar-item sync-btn" onclick="startSync()"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23E86B35' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='23 4 23 10 17 10'%3E%3C/polyline%3E%3Cpolyline points='1 20 1 14 7 14'%3E%3C/polyline%3E%3Cpath d='M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15'%3E%3C/path%3E%3C/svg%3E" class="sidebar-icon"><span class="sidebar-text">Обновить данные</span></div></li>
        <% if (user && user.role === 'superadmin') { %>
            <li><a href="<%= baseUrl %>/admin/users" class="sidebar-item"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2'%3E%3C/path%3E%3Ccircle cx='9' cy='7' r='4'%3E%3C/circle%3E%3Cpath d='M23 21v-2a4 4 0 0 0-3-3.87'%3E%3C/path%3E%3Cpath d='M16 3.13a4 4 0 0 1 0 7.75'%3E%3C/path%3E%3C/svg%3E" class="sidebar-icon"><span class="sidebar-text">Пользователи</span></a></li>
        <% } %>
        <li><div class="sidebar-item" onclick="openSettingsModal()"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='3'%3E%3C/circle%3E%3Cpath d='M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1-2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z'%3E%3C/path%3E%3C/svg%3E" class="sidebar-icon"><span class="sidebar-text">Настройки</span></div></li>
    </ul>
    <div class="sidebar-footer">
        <div class="user-profile">
            <img src="<%= user && user.avatar ? user.avatar : baseUrl + '/public/avatar1.png' %>" class="user-avatar">
            <span class="user-name"><%= user ? user.fullName : 'Гость' %></span>
        </div>
        <div class="user-profile"><img src="<%= user && user.avatar ? user.avatar : baseUrl + '/public/avatar1.png' %>" class="user-avatar"><span class="user-name"><%= user ? user.fullName : 'Гость' %></span></div>
        <a href="<%= baseUrl %>/logout" class="sidebar-item"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4'%3E%3C/path%3E%3Cpolyline points='16 17 21 12 16 7'%3E%3C/polyline%3E%3Cline x1='21' y1='12' x2='9' y2='12'%3E%3C/line%3E%3C/svg%3E" class="sidebar-icon"><span class="sidebar-text">Выход</span></a>
        <button class="sidebar-item" id="sidebarToggle" style="background:none; border:none; width:100%; text-align:left"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolygon points='5 3 19 12 5 21 5 3'%3E%3C/polygon%3E%3C/svg%3E" class="sidebar-icon"><span class="sidebar-text">Свернуть</span></button>
    </div>
</div>

<div id="settingsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
    <div style="background:white; padding:30px; border-radius:15px; width:450px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto;">
        <h3 style="margin-top:0">Настройки</h3>
        
        <div style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">
            <h4 style="margin-bottom:15px">Профиль учетной записи</h4>
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px">
                <img id="currentAvatarPreview" src="<%= user && user.avatar ? user.avatar : baseUrl + '/public/avatar1.png' %>" style="width:60px; height:60px; border-radius:50%; object-fit:cover; border: 1px solid #ddd">
                <input type="file" id="inputAvatar" style="font-size:12px">
            </div>
            <div style="margin-bottom:15px">
                <label style="display:block; font-size:12px; font-weight:700; margin-bottom:5px">ФИО</label>
                <input type="text" id="inputFullName" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;" value="<%= user ? user.fullName : '' %>">
            </div>
            <button onclick="saveProfile()" style="padding:8px 16px; border-radius:6px; border:none; cursor:pointer; background:#333; color:white; font-size:12px">Обновить профиль</button>
        </div>

        <div style="margin-bottom:20px">
            <h4 style="margin-bottom:15px">Индикация (пороги в %)</h4>
            <label style="display:block; font-size:12px; font-weight:700; margin-bottom:5px">Нижний порог (Желтый)</label>
            <input type="number" id="inputThresholdLow" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box; margin-bottom:10px" value="<%= locals.config ? config.threshold_low : 20 %>">
            <label style="display:block; font-size:12px; font-weight:700; margin-bottom:5px">Верхний порог (Красный)</label>
            <input type="number" id="inputThresholdHigh" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;" value="<%= locals.config ? config.threshold_high : 50 %>">
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px">
            <button onclick="closeSettingsModal()" style="padding:10px 20px; border-radius:8px; border:none; cursor:pointer; background:#eee; font-weight:600">Отмена</button>
            <button onclick="saveSettings()" style="padding:10px 20px; border-radius:8px; border:none; cursor:pointer; background:#E86B35; color:white; font-weight:600">Сохранить всё</button>
        </div>
    </div>
</div>

<script>
    async function saveProfile() {
        const formData = new FormData();
        const fullName = document.getElementById('inputFullName').value;
        const avatarFile = document.getElementById('inputAvatar').files[0];
        
        formData.append('fullName', fullName);
        if(avatarFile) formData.append('avatar', avatarFile);

        try {
            const res = await fetch('<%= baseUrl %>/api/user/profile', {
                method: 'POST',
                body: formData
            });
            if(res.ok) window.location.reload();
            else alert('Ошибка при обновлении профиля');
        } catch(e) { alert('Ошибка сети'); }
    }

    async function startSync() {
        if(!confirm('Запустить синхронизацию?')) return;
        const res = await fetch('<%= baseUrl %>/api/sync/start', { method: 'POST' });
        const data = await res.json();
        alert(data.success ? 'Синхронизация запущена' : 'Ошибка запуска');
    }
    function openSettingsModal() { document.getElementById('settingsModal').style.display = 'flex'; }
    function closeSettingsModal() { document.getElementById('settingsModal').style.display = 'none'; }
    async function saveSettings() {
        const threshold_low = document.getElementById('inputThresholdLow').value;
        const threshold_high = document.getElementById('inputThresholdHigh').value;
        try {
            const res = await fetch('<%= baseUrl %>/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({threshold_low, threshold_high})
            });
            if(res.ok) window.location.reload();
        } catch(e) { alert('Ошибка сети'); }
    }
</script>