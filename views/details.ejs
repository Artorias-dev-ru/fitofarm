<!DOCTYPE html>
<html>
<head>
    <title>Детали адреса</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        /* Стили специфичные для контента вкладок */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div class="header-section">
        <a href="/"><img src="/logo.svg" alt="ФИТОФАРМ" style="height: 32px;"></a>
    </div>

    <div class="details-container">
        
        <div class="object-header">
            <div class="object-title-box">
                <div class="object-label">Адрес</div>
                <div class="object-city"><%= item.city %></div>
                <div class="object-address"><%= item.address %></div>
            </div>
    
            <div class="header-stats">
                <div class="stats-group">
                    <span class="stats-label">Продажа</span>
                    <a href="/details/<%= item.id %>?type=sales" class="stat-card sales">
                        ✓ <%= item.sales %>
                    </a>
                </div>

                <div class="stats-group">
                    <span class="stats-label">Отказы</span>
                    <a href="/details/<%= item.id %>?type=refusals" class="stat-card refusals">
                        × <%= item.refusals %>
                    </a>
                </div>

                <div class="stats-group">
                    <span class="stats-label">Нераспозн</span>
                    <a href="/details/<%= item.id %>?type=unknown" class="stat-card unknown">
                        ⓘ <%= item.unknown %>
                    </a>
                </div>

                <div class="stats-group">
                    <span class="stats-label">Итого</span>
                    <a href="/details/<%= item.id %>" class="stat-card total">
                        <%= item.sales + item.refusals + item.unknown %>
                    </a>
                </div>
            </div>

            <div style="margin-left: auto;">
                <div class="input-capsule date-picker-wrapper">
                    <input type="text" id="details-date-picker" placeholder="с 12.01 по 20.01">
                </div>
            </div>
        </div>

        <div class="details-grid">
            
            <div class="dialog-sidebar">
                <% if(dialogues.length === 0) { %>
                    <div style="color: #999; text-align: center; margin-top: 20px;">Нет диалогов</div>
                <% } %>
                <% dialogues.forEach(dialog => { %>
                    <a href="/details/<%= item.id %>?type=<%= activeType %>&dialogId=<%= dialog.id %>&tab=<%= activeTab %>" 
                       class="dialog-card <%= (activeDialog && activeDialog.id === dialog.id) ? 'active' : '' %>"
                       style="text-decoration: none;">
                        <span>Диалог <%= dialog.number %></span>
                        <svg class="download-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                    </a>
                <% }) %>
            </div>

            <div class="transcript-area">
                <% if (activeDialog) { %>
                    <div style="margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="font-weight: 700; font-size: 16px;">Диалог <%= activeDialog.number %></span>
                            <span style="color: #999; font-size: 13px; margin-left: 10px;">
                                (<%= activeDialog.status === 'sales' ? 'Продажа' : activeDialog.status === 'refusals' ? 'Отказ' : 'Нераспознан' %>)
                            </span>
                        </div>
                        <div style="display: flex; gap: 10px; opacity: 0.5;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="cursor: pointer;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="cursor: pointer;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        </div>
                    </div>
                    <pre style="white-space: pre-wrap; font-family: 'Inter', sans-serif; color: #444; font-size: 14px;"><%= activeDialog.text %></pre>
                <% } else { %>
                    <div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #999;">
                        Выберите диалог из списка слева
                    </div>
                <% } %>
            </div>

            <div class="actions-sidebar">
                
                <div class="audio-player-mock">
                    <div class="player-controls">
                        <div class="play-btn">▶</div>
                        <div style="font-size: 12px; font-weight: 600;">0:00 - 7:45</div>
                        <div style="margin-left: auto; display: flex; gap: 5px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon></svg>
                        </div>
                    </div>
                    <div class="progress-bar"></div>
                </div>

                <div class="tabs-container">
                    <button class="tab-btn <%= activeTab === 'summary' ? 'active' : '' %>" onclick="openTab('summary')">Краткий отчет</button>
                    <button class="tab-btn <%= activeTab === 'notes' ? 'active' : '' %>" onclick="openTab('notes')">Заметки</button>
                </div>

                <div class="report-body">
                    <div id="tab-summary" class="tab-content <%= activeTab === 'summary' ? 'active' : '' %>">
                        <% if (activeDialog) { %>
                            <p style="margin-top: 0;"><strong>Краткое содержание:</strong></p>
                            <p style="line-height: 1.6; color: #555;">
                                <%= activeDialog.summary %>
                            </p>
                        <% } else { %>
                            <p style="color:#999">...</p>
                        <% } %>
                    </div>

                    <div id="tab-notes" class="tab-content <%= activeTab === 'notes' ? 'active' : '' %>">
                        <% if (activeDialog) { %>
                            <textarea id="note-textarea" placeholder="Напишите заметку к диалогу..."><%= activeDialog.note || '' %></textarea>
                            <button class="save-btn" onclick="saveNote(<%= activeDialog.id %>)">Сохранить</button>
                        <% } else { %>
                            <p style="color:#999">Выберите диалог</p>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
    <script>
        // Функция переключения вкладок
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById('tab-' + tabName).classList.add('active');
            const btnIndex = tabName === 'summary' ? 0 : 1;
            document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');

            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('tab', tabName);
            window.history.replaceState({}, '', currentUrl);

            const linksToUpdate = document.querySelectorAll('.stat-card, .dialog-card'); // Обновили селектор класса
            linksToUpdate.forEach(link => {
                const url = new URL(link.href, window.location.origin);
                url.searchParams.set('tab', tabName);
                link.href = url.toString();
            });
        }

        async function saveNote(dialogId) {
            const text = document.getElementById('note-textarea').value;
            const btn = document.querySelector('.save-btn');
            const originalText = btn.innerText;
            
            btn.innerText = "Сохранение...";
            
            try {
                const response = await fetch('/api/save-note', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dialogId: dialogId, note: text })
                });
                
                if (response.ok) {
                    btn.innerText = "Сохранено!";
                    setTimeout(() => btn.innerText = originalText, 2000);
                } else {
                    btn.innerText = "Ошибка";
                }
            } catch (e) {
                console.error(e);
                btn.innerText = "Ошибка сети";
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            const urlParams = new URLSearchParams(window.location.search);
            const startParam = urlParams.get('startDate');
            const endParam = urlParams.get('endDate');
            const currentTab = urlParams.get('tab') || 'summary';
    
            if (startParam && endParam) {
                const linksToUpdate = document.querySelectorAll('.stat-card, .dialog-card');
                linksToUpdate.forEach(link => {
                    const url = new URL(link.href, window.location.origin);
                    url.searchParams.set('startDate', startParam);
                    url.searchParams.set('endDate', endParam);
                    url.searchParams.set('tab', currentTab); 
                    url.searchParams.delete('period');
                    link.href = url.toString();
                });
            }

            let defaultDates = [];
            if (startParam && endParam) {
                defaultDates = [startParam, endParam];
            }
    
            flatpickr("#details-date-picker", {
                mode: "range",
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d.m.Y", 
                locale: "ru",
                defaultDate: defaultDates,
                onClose: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length === 2) {
                        const start = instance.formatDate(selectedDates[0], "Y-m-d");
                        const end = instance.formatDate(selectedDates[1], "Y-m-d");
                        const currentUrl = new URL(window.location.href);
                        currentUrl.searchParams.set('startDate', start);
                        currentUrl.searchParams.set('endDate', end);
                        currentUrl.searchParams.delete('period'); 
                        currentUrl.searchParams.set('tab', currentTab);
                        window.location.href = currentUrl.toString();
                    }
                }
            });
        });
    </script>
</body>
</html>