<!DOCTYPE html>
<html>
<head>
    <title>Детали адреса</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .stat-icon {
            width: 14px;
            margin-right: 6px;
            vertical-align: middle;
        }
        
        .player-controls .play-btn {
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .player-controls .play-btn:hover { opacity: 0.8; }
        .player-disabled { opacity: 0.5; pointer-events: none; }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            width: 100px;
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            cursor: pointer;
            height: 14px;
            margin: 0;
            background-size: 100% 4px;
            background-position: center;
            background-repeat: no-repeat;
        }

        input[type=range]:focus { outline: none; }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: transparent;
            border-radius: 2px;
        }
        
        input[type=range]::-webkit-slider-thumb {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #333;
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -4px;
            transition: transform 0.1s;
        }

        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }

        #seek-slider { margin-top: 10px; }
        #volume-slider { width: 70px; }
    </style>
</head>
<body>
    <div class="header-container">
    <div class="logo-row">
        <a href="/">
            <div class="logo-box">
                <img src="/logo.svg" alt="ФИТОФАРМ" style="height: 6vh;">
            </div>
        </a>
    </div>
</div>

    <div class="details-container">
        
        <div class="object-header">
            <div class="object-title-box">
                <div class="object-label">Адрес</div>
                <div class="object-city"><%= item.city %></div>
                <div class="object-address"><%= item.address %></div>
            </div>
    
            <div class="header-stats">
                <div class="stats-group">
                    <span class="stats-label">Продажа</span>
                    <a href="/details/<%= item.id %>?type=sales" class="stat-card sales">
                        <img src="/icons/sale.svg" class="stat-icon" style="width: 25px; margin-right: 10px;" alt="Sales">
                        <%= item.sales %>
                    </a>
                </div>

                <div class="stats-group">
                    <span class="stats-label">Отказы</span>
                    <a href="/details/<%= item.id %>?type=refusals" class="stat-card refusals">
                        <img src="/icons/refuse.svg" class="stat-icon" style="width: 25px; margin-right: 10px;" alt="Refusals">
                        <%= item.refusals %>
                    </a>
                </div>

                <div class="stats-group">
                    <span class="stats-label">Нераспозн</span>
                    <a href="/details/<%= item.id %>?type=unknown" class="stat-card unknown">
                        <img src="/icons/warning.svg" class="stat-icon" style="width: 35px; margin-right: 10px;" alt="Unknown" style="opacity: 0.6;">
                        <%= item.unknown %>
                    </a>
                </div>

                <div class="stats-group">
                    <span class="stats-label">Итого</span>
                    <a href="/details/<%= item.id %>" class="stat-card total">
                        <%= item.sales + item.refusals + item.unknown %>
                    </a>
                </div>
            </div>

            <div style="margin-left: auto;">
                <div class="input-capsule date-picker-wrapper" style="background: transparent;">
                    <input type="text" id="details-date-picker" placeholder="с 12.01 по 20.01">
                </div>
            </div>
        </div>

        <div class="details-grid">
            
            <div class="dialog-sidebar">
                <% if(dialogues.length === 0) { %>
                    <div style="color: #999; text-align: center; margin-top: 20px;">Нет диалогов</div>
                <% } %>
                <% dialogues.forEach(dialog => { %>
                    <a href="/details/<%= item.id %>?type=<%= activeType %>&dialogId=<%= dialog.id %>&tab=<%= activeTab %>" 
                       class="dialog-card <%= (activeDialog && activeDialog.id === dialog.id) ? 'active' : '' %>"
                       style="text-decoration: none;">
                        <span>Диалог <%= dialog.number %></span>
                        <img src="/icons/download.svg" class="download-icon" style="width: 16px; opacity: 0.5;"> 
                    </a>
                <% }) %>
            </div>

            <div class="transcript-area">
                <% if (activeDialog) { %>
                    <div style="margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="font-weight: 700; font-size: 16px;">Диалог <%= activeDialog.number %></span>
                            <span style="color: #999; font-size: 13px; margin-left: 10px;">
                                (<%= activeDialog.status === 'sales' ? 'Продажа' : activeDialog.status === 'refusals' ? 'Отказ' : 'Нераспознан' %>)
                            </span>
                        </div>
                        <div style="display: flex; gap: 10px; opacity: 0.5;">
                            <div style="display: flex; gap: 10px; opacity: 0.5;">
                                <img src="/icons/copy.svg" 
                                     style="width: 18px; height: 18px; cursor: pointer;" 
                                     alt="Копировать"
                                     title="Копировать текст">
    
                                <img src="/icons/download.svg" 
                                     style="width: 18px; height: 18px; cursor: pointer;" 
                                     alt="Скачать"
                                     title="Скачать транскрипцию">
                            </div>
                        </div>
                    </div>
                    <div style="overflow-y: auto;height: 90%;"><pre style="white-space: pre-wrap; font-family: 'Inter', sans-serif; color: #444; font-size: 14px;"><%= activeDialog.text %></pre></div>
                <% } else { %>
                    <div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #999;">
                        Выберите диалог из списка слева
                    </div>
                <% } %>
            </div>

            <div class="actions-sidebar">

                <div class="audio-player-mock <%= (!activeDialog || !activeDialog.audioUrl) ? 'player-disabled' : '' %>">
                    <% if (activeDialog && activeDialog.audioUrl) { %>
                        <audio id="main-audio" src="<%= activeDialog.audioUrl %>"></audio>
                    <% } %>
                    
                    <div class="player-controls">
                        <div class="play-btn" onclick="toggleAudio()">
                            <img id="play-icon" src="/icons/play.svg" style="width: 25px; filter: invert(1);">
                        </div>
                        <div style="font-size: 12px; font-weight: 600; min-width: 80px;">
                            <span id="current-time">0:00</span> / <span id="duration">0:00</span>
                        </div>
                        
                        <div class="volume-control">
                            <img src="/icons/volume.svg" style="width: 16px; opacity: 0.7;">
                            <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="1">
                        </div>
                    </div>

                    <input type="range" id="seek-slider" max="100" value="0">
                </div>

                <div class="tabs-container">
                    <button class="tab-btn <%= activeTab === 'summary' ? 'active' : '' %>" onclick="openTab('summary')">Краткий отчет</button>
                    <button class="tab-btn <%= activeTab === 'notes' ? 'active' : '' %>" onclick="openTab('notes')">Заметки</button>
                </div>

                <div class="report-body">
                    <div id="tab-summary" class="tab-content <%= activeTab === 'summary' ? 'active' : '' %>">
                        <% if (activeDialog) { %>
                            <p style="margin-top: 0;"><strong>Краткое содержание:</strong></p>
                            <p style="line-height: 1.6; color: #555;">
                                <%= activeDialog.summary %>
                            </p>
                        <% } else { %>
                            <p style="color:#999">...</p>
                        <% } %>
                    </div>

                    <div id="tab-notes" class="tab-content <%= activeTab === 'notes' ? 'active' : '' %>">
                        <% if (activeDialog) { %>
                            <textarea id="note-textarea" placeholder="Напишите заметку к диалогу..."><%= activeDialog.note || '' %></textarea>
                            <button class="save-btn" onclick="saveNote(<%= activeDialog.id %>)">Сохранить</button>
                        <% } else { %>
                            <p style="color:#999">Выберите диалог</p>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
    <script>
        const audio = document.getElementById('main-audio');
        const playIcon = document.getElementById('play-icon');
        const seekSlider = document.getElementById('seek-slider');
        const volumeSlider = document.getElementById('volume-slider');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        
        let isDragging = false;

        if (audio) {
            audio.addEventListener('loadedmetadata', () => {
                durationEl.innerText = formatTime(audio.duration);
                seekSlider.max = Math.floor(audio.duration);
            });

            audio.addEventListener('timeupdate', () => {
                if (!isDragging) {
                    seekSlider.value = Math.floor(audio.currentTime);
                    currentTimeEl.innerText = formatTime(audio.currentTime);
                    updateSliderBackground(seekSlider);
                }
            });

            audio.addEventListener('ended', () => {
                playIcon.src = "/icons/play.svg";
                seekSlider.value = 0;
                updateSliderBackground(seekSlider);
            });

            seekSlider.addEventListener('mousedown', () => {
                isDragging = true;
            });

            seekSlider.addEventListener('touchstart', () => {
                isDragging = true;
            });

            seekSlider.addEventListener('input', () => {
                isDragging = true;
                currentTimeEl.innerText = formatTime(seekSlider.value);
                updateSliderBackground(seekSlider);
                audio.currentTime = seekSlider.value;
            });

            seekSlider.addEventListener('change', () => {
                audio.currentTime = seekSlider.value;
                isDragging = false;
            });

            seekSlider.addEventListener('mouseup', () => {
                isDragging = false;
            });

            seekSlider.addEventListener('touchend', () => {
                isDragging = false;
            });

            volumeSlider.addEventListener('input', (e) => {
                audio.volume = e.target.value;
                updateSliderBackground(volumeSlider);
            });
            
            // Инициализация фона при загрузке
            updateSliderBackground(volumeSlider);
            updateSliderBackground(seekSlider);
        }

        function updateSliderBackground(slider) {
            const min = slider.min ? parseFloat(slider.min) : 0;
            const max = slider.max ? parseFloat(slider.max) : 100;
            const val = slider.value ? parseFloat(slider.value) : 0;
            
            const percentage = (val - min) / (max - min) * 100;
            
            slider.style.background = `linear-gradient(to right, #333 0%, #333 ${percentage}%, #e0e0e0 ${percentage}%, #e0e0e0 100%)`;
            slider.style.backgroundSize = '100% 4px';
            slider.style.backgroundRepeat = 'no-repeat';
            slider.style.backgroundPosition = 'center';
        }

        function toggleAudio() {
            if (!audio) return;
            if (audio.paused) {
                audio.play();
            } else {
                audio.pause();
                playIcon.src = "/icons/play.svg";
            }
        }

        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return "0:00";
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById('tab-' + tabName).classList.add('active');
            const btnIndex = tabName === 'summary' ? 0 : 1;
            document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');

            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('tab', tabName);
            window.history.replaceState({}, '', currentUrl);

            const linksToUpdate = document.querySelectorAll('.stat-card, .dialog-card');
            linksToUpdate.forEach(link => {
                const url = new URL(link.href, window.location.origin);
                url.searchParams.set('tab', tabName);
                link.href = url.toString();
            });
        }

        async function saveNote(dialogId) {
            const text = document.getElementById('note-textarea').value;
            const btn = document.querySelector('.save-btn');
            const originalText = btn.innerText;
            
            btn.innerText = "Сохранение...";
            
            try {
                const response = await fetch('/api/save-note', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dialogId: dialogId, note: text })
                });
                
                if (response.ok) {
                    btn.innerText = "Сохранено!";
                    setTimeout(() => btn.innerText = originalText, 2000);
                } else {
                    btn.innerText = "Ошибка";
                }
            } catch (e) {
                console.error(e);
                btn.innerText = "Ошибка сети";
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            const activeCard = document.querySelector('.dialog-card.active');
            if (activeCard) {
                activeCard.scrollIntoView({
                    behavior: 'auto',
                    block: 'center'
                });
            }

            const urlParams = new URLSearchParams(window.location.search);
            const startParam = urlParams.get('startDate');
            const endParam = urlParams.get('endDate');
            const currentTab = urlParams.get('tab') || 'summary';
    
            if (startParam && endParam) {
                const linksToUpdate = document.querySelectorAll('.stat-card, .dialog-card');
                linksToUpdate.forEach(link => {
                    const url = new URL(link.href, window.location.origin);
                    url.searchParams.set('startDate', startParam);
                    url.searchParams.set('endDate', endParam);
                    url.searchParams.set('tab', currentTab); 
                    url.searchParams.delete('period');
                    link.href = url.toString();
                });
            }

            let defaultDates = [];
            if (startParam && endParam) {
                defaultDates = [startParam, endParam];
            }
    
            flatpickr("#details-date-picker", {
                mode: "range",
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d.m.Y", 
                locale: "ru",
                defaultDate: defaultDates,
                onClose: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length === 2) {
                        const start = instance.formatDate(selectedDates[0], "Y-m-d");
                        const end = instance.formatDate(selectedDates[1], "Y-m-d");
                        const currentUrl = new URL(window.location.href);
                        currentUrl.searchParams.set('startDate', start);
                        currentUrl.searchParams.set('endDate', end);
                        currentUrl.searchParams.delete('period'); 
                        currentUrl.searchParams.set('tab', currentTab);
                        window.location.href = currentUrl.toString();
                    }
                }
            });
        });
    </script>
</body>
</html>