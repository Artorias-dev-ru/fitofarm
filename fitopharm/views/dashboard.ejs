<!DOCTYPE html>
<html>
<head>
    <title>Дашборд</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="<%= baseUrl %>/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    
    <%- include('sidebar') %>

    <div class="content-wrapper" id="contentWrapper">
        
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <div class="stats-dashboard">
            <div class="chart-box">
                <div class="chart-title">Доли статусов</div>
                <div class="canvas-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="chart-box">
                <div class="chart-title">Всего за период</div>
                <div class="canvas-container">
                    <canvas id="totalBarChart"></canvas>
                </div>
            </div>
            <div class="chart-box wide">
                <div class="chart-title">Динамика по дням</div>
                <div class="canvas-container">
                    <canvas id="dynamicsLineChart"></canvas>
                </div>
            </div>
        </div>
        <div class="header-container">
            <div class="filter-row">
                <div class="dropdown">
                    <div class="input-capsule">
                        <%= (activePeriod === 'today') ? 'Сегодня' : 
                            (activePeriod === 'yesterday') ? 'Вчера' :
                            (activePeriod === 'week') ? 'Неделя' :
                            (activePeriod === 'month') ? 'Месяц' : 'Год' %> ▾
                    </div>
                    <div class="dropdown-content">
                        <a href="<%= baseUrl %>/?period=today">Сегодня</a>
                        <a href="<%= baseUrl %>/?period=yesterday">Вчера</a>
                        <a href="<%= baseUrl %>/?period=week">Неделя</a>
                        <a href="<%= baseUrl %>/?period=month">Месяц</a>
                        <a href="<%= baseUrl %>/?period=year">Год</a>
                    </div>
                </div>
                
                <div class="input-capsule">
                    <input type="text" id="date-range-picker" placeholder="Выбрать период">
                </div>
                
                <div class="input-capsule" style="color: #ccc;">Город</div>
                <div class="input-capsule" style="color: #ccc;">Адрес</div>

                <div class="dropdown" style="margin-left: auto;">
                    <div class="input-capsule">
                        ≡ <%= (activeSort === 'sales') ? 'Больше продаж' : 
                              (activeSort === 'refusals') ? 'Больше отказов' : 'По алфавиту' %> ▾
                    </div>
                    <div class="dropdown-content" style="right: 0; left: auto; min-width: 180px;">
                        <a href="#" onclick="applySort('alphabet')">По алфавиту</a>
                        <a href="#" onclick="applySort('sales')">Больше продаж</a>
                        <a href="#" onclick="applySort('refusals')">Больше отказов</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="main-layout">
            <div class="grid-system data-row-container">
                <div class="data-main-card table_header">
                    <div class="data-main-card_border table_header">
                        <div class="address-cell">
                            <p class="address-cell-adress" style="color: rgb(29, 29, 27);">Анапа</p>
                        </div>
                        <p>Продажа</p>
                        <p>Отказ</p>
                        <p>Прочее</p>
                    </div>
                </div>
                <div class="total-card" style="background-color: rgb(223, 225, 229); border-radius: 5px; font-size: 1.3vw; color: rgb(178, 178, 178); font-weight: 400;">
                    Итог
                </div>
            </div>

            <% data.forEach(item => { %>
                <div class="grid-system data-row-container">
                    <div class="data-main-card" onclick="window.location.href='<%= baseUrl %>/details/<%= item.id %>' + window.location.search">
                        <div class="data-main-card_border">
                            <div class="address-cell">
                                <b style="font-size: 0.9vw;"><%= item.address %></b>
                            </div>
                            <div class="pill green">
                                <img src="<%= baseUrl %>/icons/sale.svg" style="width: 15px; margin-right: 5px;"> <%= item.sales %>
                            </div>
                            <div class="pill red">
                                <img src="<%= baseUrl %>/icons/refuse.svg" style="width: 15px; margin-right: 5px;"> <%= item.refusals %>
                            </div>
                            <div class="pill grey">
                                <img src="<%= baseUrl %>/icons/warning.svg" style="width: 20px; margin-right: 5px;"> <%= item.unknown %>
                            </div>
                        </div>
                    </div>
                    <div class="total-card">
                        <%= item.sales + item.refusals + item.unknown %>
                    </div>
                </div>
            <% }) %>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dashboardData = <%- JSON.stringify(data) %>;
            let totalSales = 0;
            let totalRefusals = 0;
            let totalUnknown = 0;
            const dailyData = {};

            dashboardData.forEach(record => {
                if (record.Dialogs) {
                    record.Dialogs.forEach(dialog => {
                        if (dialog.status === 'sales') totalSales++;
                        else if (dialog.status === 'refusals') totalRefusals++;
                        else totalUnknown++;
    
                        const date = dialog.date;
                        if (date) {
                            if (!dailyData[date]) {
                                dailyData[date] = { sales: 0, refusals: 0, unknown: 0 };
                            }
                            if (dialog.status === 'sales') dailyData[date].sales++;
                            else if (dialog.status === 'refusals') dailyData[date].refusals++;
                            else dailyData[date].unknown++;
                        }
                   });
                }
            });

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            };
    
            new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Продажи', 'Отказы', 'Прочее'],
                    datasets: [{
                        data: [totalSales, totalRefusals, totalUnknown],
                        backgroundColor: ['#27ae60', '#c0392b', '#999999'],
                        borderWidth: 0
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        legend: { display: true, position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } }
                    }
                }
            });

            new Chart(document.getElementById('totalBarChart'), {
                type: 'bar',
                data: {
                    labels: ['Продажи', 'Отказы', 'Прочее'],
                    datasets: [{
                        data: [totalSales, totalRefusals, totalUnknown],
                        backgroundColor: ['#27ae60', '#c0392b', '#999999'],
                        borderRadius: 4
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f0f0f0' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            const sortedDates = Object.keys(dailyData).sort();
            new Chart(document.getElementById('dynamicsLineChart'), {
                type: 'line',
                data: {
                    labels: sortedDates.map(d => d.split('-').reverse().slice(0, 2).join('.')),
                    datasets: [
                        {
                            label: 'Продажи',
                            data: sortedDates.map(d => dailyData[d].sales),
                            borderColor: '#27ae60',
                            backgroundColor: '#27ae60',
                            tension: 0,
                            pointRadius: 2
                        },
                        {
                            label: 'Отказы',
                            data: sortedDates.map(d => dailyData[d].refusals),
                            borderColor: '#c0392b',
                            backgroundColor: '#c0392b',
                            tension: 0,
                            pointRadius: 2
                        },
                        {
                            label: 'Нераспознано',
                            data: sortedDates.map(d => dailyData[d].unknown),
                            borderColor: '#999999',
                            backgroundColor: '#999999',
                            tension: 0,
                            pointRadius: 2
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        legend: { display: true, position: 'top', align: 'end' }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f0f0f0' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        });

        document.addEventListener("DOMContentLoaded", function() {
            const urlParams = new URLSearchParams(window.location.search);
            const startParam = urlParams.get('startDate');
            const endParam = urlParams.get('endDate');

            let defaultDates = [];
            if (startParam && endParam) defaultDates = [startParam, endParam];

            flatpickr("#date-range-picker", {
                mode: "range",
                dateFormat: "Y-m-d",
                altInput: true,
                altFormat: "d.m.Y",
                locale: "ru",
                defaultDate: defaultDates,
                onClose: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length === 2) {
                        const start = instance.formatDate(selectedDates[0], "Y-m-d");
                        const end = instance.formatDate(selectedDates[1], "Y-m-d");
                        const currentUrl = new URL(window.location.href);
                        currentUrl.searchParams.set('startDate', start);
                        currentUrl.searchParams.set('endDate', end);
                        currentUrl.searchParams.delete('period');
                        window.location.href = currentUrl.toString();
                    }
                }
            });

            const dropdowns = document.querySelectorAll('.dropdown');
            dropdowns.forEach(dropdown => {
                const trigger = dropdown.querySelector('.input-capsule');
                trigger.addEventListener('click', function(event) {
                    event.stopPropagation();
                    dropdowns.forEach(d => { if (d !== dropdown) d.classList.remove('active'); });
                    dropdown.classList.toggle('active');
                });
            });
            document.addEventListener('click', function(event) {
                dropdowns.forEach(dropdown => { if (!dropdown.contains(event.target)) dropdown.classList.remove('active'); });
            });
        });

        function applySort(sortType) {
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('sortType', sortType);
            window.location.href = currentUrl.toString();
        }
    </script>
</body>
</html>