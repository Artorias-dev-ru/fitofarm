<!DOCTYPE html>
<html>
<head>
    <title>Дашборд</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="<%= baseUrl %>/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    
    <%- include('sidebar') %>

    <div class="content-wrapper" id="contentWrapper"> 
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

        <div class="stats-dashboard">
            <div class="chart-box" style="border-radius: 20px 0 0 20px;">
                <div class="canvas-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="chart-box">
                <div class="canvas-container">
                    <canvas id="totalBarChart"></canvas>
                </div>
            </div>
            <div class="chart-box wide" style="border-radius: 0px 20px 20px 0px;">
                <div class="canvas-container">
                    <canvas id="dynamicsLineChart"></canvas>
                </div>
            </div>
        </div>

        <div class="header-container">
            <div class="filter-row">
                <div class="dropdown">
                    <div class="input-capsule">
                        <%= (activePeriod === 'today') ? 'Сегодня' : 
                            (activePeriod === 'yesterday') ? 'Вчера' :
                            (activePeriod === 'week') ? 'Неделя' :
                            (activePeriod === 'month') ? 'Месяц' :
                            (activePeriod === 'year') ? 'Год' : 
                            (currentRange ? 'Период' : 'Все время') %> ▾
                    </div>
                    <div class="dropdown-content">
                        <a href="<%= baseUrl %>/?period=today">Сегодня</a>
                        <a href="<%= baseUrl %>/?period=yesterday">Вчера</a>
                        <a href="<%= baseUrl %>/?period=week">Неделя</a>
                        <a href="<%= baseUrl %>/?period=month">Месяц</a>
                        <a href="<%= baseUrl %>/?period=year">Год</a>
                    </div>
                </div>
                
                <div class="input-capsule">
                    <input type="text" id="date-range-picker" placeholder="Выбрать период" value="<%= currentRange %>">
                </div>
                
                <div class="input-capsule" style="color: #ccc;">Город</div>
                <div class="input-capsule" style="color: #ccc;">Адрес</div>

                <div class="dropdown" style="margin-left: auto;">
                    <div class="input-capsule">
                        ≡ <%= (activeSort === 'sales') ? 'Больше продаж' : 
                              (activeSort === 'refusals') ? 'Больше отказов' : 'По алфавиту' %> ▾
                    </div>
                    <div class="dropdown-content" style="right: 0; left: auto; min-width: 180px;">
                        <a href="#" onclick="applySort('alphabet')">По алфавиту</a>
                        <a href="#" onclick="applySort('sales')">Больше продаж</a>
                        <a href="#" onclick="applySort('refusals')">Больше отказов</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-layout">
            <div class="grid-system data-row-container">
                <div class="data-main-card table_header">
                    <div class="data-main-card_border table_header">
                        <div class="address-cell">
                            <p class="address-cell-adress" style="color: rgb(29, 29, 27);">Анапа</p>
                        </div>
                        <p>Продажа</p>
                        <p>Отказ</p>
                        <p>Нераспознан</p>
                    </div>
                </div>
                <div class="total-card" style="background-color: rgb(223, 225, 229); border-radius: 5px; font-size: 1.3vw; color: rgb(178, 178, 178); font-weight: 400;">
                    Итог
                </div>
            </div>

            <% data.forEach(item => { %>
                <div class="grid-system data-row-container">
                    <div class="data-main-card" onclick="window.location.href='<%= baseUrl %>/details/<%= item.id %>' + window.location.search">
                        <div class="data-main-card_border">
                            <div class="address-cell">
                                <b style="font-size: 0.9vw;"><%= item.address %></b>
                            </div>
                            <div class="pill green">
                                <img src="<%= baseUrl %>/icons/sale.svg" style="width: 15px; margin-right: 5px;"> <%= item.sales %>
                            </div>
                            <div class="pill red">
                                <img src="<%= baseUrl %>/icons/refuse.svg" style="width: 15px; margin-right: 5px;"> <%= item.refusals %>
                            </div>
                            <div class="pill grey">
                                <img src="<%= baseUrl %>/icons/warning.svg" style="width: 20px; margin-right: 5px;"> <%= item.unknown %>
                            </div>
                        </div>
                    </div>
                    <div class="total-card">
                        <%= item.sales + item.refusals + item.unknown %>
                    </div>
                </div>
            <% }) %>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    Chart.register(ChartDataLabels);

    const dashboardData = <%- JSON.stringify(data) %>;
    
    const urlParams = new URLSearchParams(window.location.search);
    const activePeriod = urlParams.get('period');
    const startDateParam = urlParams.get('startDate');
    const endDateParam = urlParams.get('endDate');

    let periodLabel = 'Все время';
    if (startDateParam && endDateParam) {
        const s = startDateParam.split('-');
        const e = endDateParam.split('-');
        periodLabel = `${s[2]}.${s[1]} - ${e[2]}.${e[1]}`;
    } else if (activePeriod === 'today') periodLabel = 'Сегодня';
    else if (activePeriod === 'yesterday') periodLabel = 'Вчера';
    else if (activePeriod === 'week') periodLabel = 'Неделя';
    else if (activePeriod === 'month') periodLabel = 'Месяц';
    else if (activePeriod === 'year') periodLabel = 'Год';

    let filteredSales = 0;
    let filteredRefusals = 0;
    let filteredUnknown = 0;

    let globalSales = 0;
    let globalRefusals = 0;
    let globalUnknown = 0;
    const globalDailyData = {};

    dashboardData.forEach(record => {
        if (record.Dialogs) {
            record.Dialogs.forEach(d => {
                if (d.status === 'sales') filteredSales++;
                else if (d.status === 'refusals') filteredRefusals++;
                else filteredUnknown++;
            });
        }
        const dialogsForGlobal = record.globalDialogs || record.Dialogs || [];
        dialogsForGlobal.forEach(d => {
            if (d.status === 'sales') globalSales++;
            else if (d.status === 'refusals') globalRefusals++;
            else globalUnknown++;

            const date = d.date;
            if (date) {
                if (!globalDailyData[date]) {
                    globalDailyData[date] = { sales: 0, refusals: 0, unknown: 0 };
                }
                if (d.status === 'sales') globalDailyData[date].sales++;
                else if (d.status === 'refusals') globalDailyData[date].refusals++;
                else globalDailyData[date].unknown++;
            }
        });
    });

    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false
    };

    const centerTextPlugin = {
        id: 'centerText',
        beforeDraw: function(chart) {
            if (chart.config.type !== 'doughnut') return;
            const { ctx, chartArea: {top, bottom, left, right} } = chart;
            ctx.restore();
            const height = bottom - top;
            const fontSize = (height / 140).toFixed(2);
            ctx.font = "bold " + fontSize + "em Inter";
            ctx.textBaseline = "middle";
            ctx.fillStyle = "#333";
            const text = periodLabel;
            const textX = (left + right) / 2;
            const textY = (top + bottom) / 2;
            ctx.textAlign = 'center';
            ctx.fillText(text, textX, textY);
            ctx.save();
        }
    };

    const grandTotal = filteredSales + filteredRefusals + filteredUnknown;
    const minVisualShare = grandTotal > 0 ? grandTotal * 0.08 : 0; 
    
    let visualSales = filteredSales;
    let visualRefusals = filteredRefusals;
    let visualUnknown = filteredUnknown;

    if (filteredUnknown > 0 && filteredUnknown < minVisualShare) visualUnknown = minVisualShare;
    if (filteredRefusals > 0 && filteredRefusals < minVisualShare) visualRefusals = minVisualShare;
    if (filteredSales > 0 && filteredSales < minVisualShare) visualSales = minVisualShare;
    
    const realDataValues = [filteredSales, filteredRefusals, filteredUnknown];

    new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
            labels: ['Продажи', 'Отказы', 'Нераспознан'],
            datasets: [{
                data: [visualSales, visualRefusals, visualUnknown],
                backgroundColor: ['#27ae60', '#c0392b', '#999999'],
                borderWidth: 0,
                borderRadius: 20,
                spacing: -20,
                hoverOffset: 0
            }]
        },
        plugins: [centerTextPlugin],
        options: {
            ...commonOptions,
            cutout: '85%',
            layout: { padding: 40 },
            plugins: {
                legend: { display: false },
                datalabels: {
                    color: '#000',
                    font: { weight: '600', size: 14, family: 'Inter' },
                    formatter: function(value, context) {
                        const realVal = realDataValues[context.dataIndex];
                        return realVal > 0 ? realVal : '';
                    },
                    anchor: 'end',
                    align: 'end',
                    offset: 12
                },
                tooltip: { 
                    enabled: true,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const realValue = realDataValues[context.dataIndex];
                            const percentage = grandTotal > 0 ? Math.round((realValue / grandTotal) * 100) + '%' : '0%';
                            return `${label}: ${realValue} (${percentage})`;
                        }
                    }
                }
            }
        }
    });

    const saleImg = new Image(); saleImg.src = '<%= baseUrl %>/icons/sale.svg';
    const refuseImg = new Image(); refuseImg.src = '<%= baseUrl %>/icons/refuse.svg';
    const warningImg = new Image(); warningImg.src = '<%= baseUrl %>/icons/warning.svg';

    const xAxisIconsPlugin = {
        id: 'xAxisIcons',
        afterDraw: (chart) => {
            if (chart.config.type !== 'bar') return;
            const { ctx, scales: { x, y } } = chart;
            const icons = [saleImg, refuseImg, warningImg];
            const iconSize = 24;
            x.ticks.forEach((tick, index) => {
                const icon = icons[index];
                if (icon && icon.complete) {
                    const xPos = x.getPixelForTick(index);
                    const yPos = y.bottom;
                    ctx.drawImage(icon, xPos - iconSize / 2, yPos + 10, iconSize, iconSize);
                }
            });
        }
    };

    new Chart(document.getElementById('totalBarChart'), {
        type: 'bar',
        data: {
            labels: ['Sale', 'Refuse', 'Unknown'],
            datasets: [{
                data: [globalSales, globalRefusals, globalUnknown],
                backgroundColor: ['#27ae60', '#c0392b', '#999999'],
                borderRadius: 20,
                barPercentage: 0.65
            }]
        },
        plugins: [xAxisIconsPlugin],
        options: {
            ...commonOptions,
            layout: { padding: { bottom: 35, top: 10 } },
            plugins: {
                legend: { display: false },
                datalabels: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true, 
                    border: { display: true, color: '#e0e0e0' },
                    grid: { display: false },
                    ticks: { precision: 0, font: { family: 'Inter', size: 12 }, padding: 10 }
                },
                x: { 
                    border: { display: true, color: '#e0e0e0' },
                    grid: { display: false },
                    ticks: { display: false }
                }
            }
        }
    });

    const axisArrowsPlugin = {
        id: 'axisArrows',
        afterDraw: (chart) => {
            if (chart.config.type !== 'line') return;
            const { ctx, scales: { x, y } } = chart;
            ctx.save();
            ctx.fillStyle = '#9e9e9e';
            ctx.beginPath();
            ctx.moveTo(x.left, y.top - 7);
            ctx.lineTo(x.left - 4, y.top);
            ctx.lineTo(x.left + 4, y.top);
            ctx.closePath();
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(x.right + 7, y.bottom);
            ctx.lineTo(x.right, y.bottom - 4);
            ctx.lineTo(x.right, y.bottom + 4);
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        }
    };

    const sortedGlobalDates = Object.keys(globalDailyData).sort();
    new Chart(document.getElementById('dynamicsLineChart'), {
        type: 'line',
        data: {
            labels: sortedGlobalDates.map(d => d.split('-').reverse().slice(0, 2).join('.')),
            datasets: [
                {
                    label: 'Продажи',
                    data: sortedGlobalDates.map(d => globalDailyData[d].sales),
                    borderColor: '#27ae60',
                    backgroundColor: '#27ae60',
                    tension: 0,
                    pointRadius: 3,
                    borderWidth: 2
                },
                {
                    label: 'Отказы',
                    data: sortedGlobalDates.map(d => globalDailyData[d].refusals),
                    borderColor: '#c0392b',
                    backgroundColor: '#c0392b',
                    tension: 0,
                    pointRadius: 3,
                    borderWidth: 2
                },
                {
                    label: 'Нераспознан',
                    data: sortedGlobalDates.map(d => globalDailyData[d].unknown),
                    borderColor: '#999999',
                    backgroundColor: '#999999',
                    tension: 0,
                    pointRadius: 3,
                    borderWidth: 2
                }
            ]
        },
        plugins: [axisArrowsPlugin],
        options: {
            ...commonOptions,
            layout: { padding: { top: 20, right: 25, bottom: 10 } },
            plugins: {
                datalabels: { display: false },
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true, 
                    border: { display: true, color: '#9e9e9e' },
                    grid: { display: false },
                    ticks: { precision: 0, font: { family: 'Inter' }, padding: 10 }
                },
                x: { 
                    border: { display: true, color: '#9e9e9e' },
                    grid: { display: false },
                    ticks: { font: { family: 'Inter' }, padding: 10 }
                }
            }
        }
    });
});

document.addEventListener("DOMContentLoaded", function() {
    const urlParams = new URLSearchParams(window.location.search);
    const startParam = urlParams.get('startDate');
    const endParam = urlParams.get('endDate');

    let defaultDates = [];
    if (startParam && endParam) defaultDates = [startParam, endParam];

    flatpickr("#date-range-picker", {
        mode: "range",
        dateFormat: "Y-m-d",
        altInput: true,
        altFormat: "d.m.Y",
        locale: "ru",
        defaultDate: defaultDates,
        onClose: function(selectedDates, dateStr, instance) {
            if (selectedDates.length === 2) {
                const start = instance.formatDate(selectedDates[0], "Y-m-d");
                const end = instance.formatDate(selectedDates[1], "Y-m-d");
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.set('startDate', start);
                currentUrl.searchParams.set('endDate', end);
                currentUrl.searchParams.delete('period');
                window.location.href = currentUrl.toString();
            }
        }
    });

    const dropdowns = document.querySelectorAll('.dropdown');
    dropdowns.forEach(dropdown => {
        const trigger = dropdown.querySelector('.input-capsule');
        if (trigger) {
            trigger.addEventListener('click', function(event) {
                event.stopPropagation();
                dropdowns.forEach(d => { if (d !== dropdown) d.classList.remove('active'); });
                dropdown.classList.toggle('active');
            });
        }
    });
    document.addEventListener('click', function(event) {
        dropdowns.forEach(dropdown => { if (!dropdown.contains(event.target)) dropdown.classList.remove('active'); });
    });
});

function applySort(sortType) {
    const currentUrl = new URL(window.location.href);
    currentUrl.searchParams.set('sortType', sortType);
    window.location.href = currentUrl.toString();
}
    </script>
</body>
</html>