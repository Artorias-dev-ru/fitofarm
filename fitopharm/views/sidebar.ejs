<style>
    .input-capsule input, 
    .flatpickr-input,
    .input-capsule .flatpickr-mobile {
        text-align: center !important;
        padding: 0 !important;
        width: 100% !important;
        background: transparent !important;
        border: none !important;
        box-shadow: none !important;
        outline: none !important;
        color: #999 !important;
        font-weight: 500;
    }

    .flatpickr-input.form-control {
        padding-right: 0 !important;
        padding-left: 0 !important;
    }

    .calendar-icon-custom, 
    .input-capsule img {
        width: 24px !important;
        height: 24px !important;
    }

    .dropdown {
        position: relative;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        top: calc(100% + 12px);
        left: 50% !important;
        transform: translateX(-50%) !important;
        background-color: #ffffff;
        min-width: 180px;
        border-radius: 12px !important;
        box-shadow: 0 10px 25px rgba(0,0,0,0.08) !important;
        border: 1px solid #edf1f4 !important;
        padding: 8px 0;
        z-index: 2000;
    }

    .dropdown.active .dropdown-content {
        display: block;
    }

    .dropdown-content.is-right {
        left: auto !important;
        right: 0 !important;
        transform: none !important;
    }

    .dropdown-content a {
        color: #4a5568;
        padding: 12px 20px;
        text-decoration: none;
        display: block;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .dropdown-content a:hover {
        background-color: #f7fafc;
        color: #27ae60;
    }
</style>

<div class="sidebar" id="sidebar">
    <a href="<%= baseUrl %>/" class="logo-container">
        <img src="<%= baseUrl %>/logo.svg" alt="ФИТОФАРМ" class="sidebar-logo-full">
        <div class="sidebar-logo-small"></div>
    </a>

    <div class="user-profile">
        <div class="user-name"><%= (typeof user !== 'undefined' && user && user.fullName) ? user.fullName : 'Пользователь' %></div>
        <div class="user-initials">
            <% 
                const name = (typeof user !== 'undefined' && user && user.fullName) ? user.fullName : 'U';
                const initials = name.split(' ').map(n => n[0]).join('.').toUpperCase();
            %>
            <%= initials %>
        </div>
    </div>

    <ul class="sidebar-menu">
        <li>
            <a href="<%= baseUrl %>/my-notes" class="sidebar-link">
                <img src="<%= baseUrl %>/icons/page.svg" class="sidebar-icon">
                <span class="sidebar-text">Мои заметки</span>
            </a>
        </li>
        <li>
            <a href="#" class="sidebar-link" onclick="openPasswordModal(event)">
                <img src="<%= baseUrl %>/icons/lock.svg" class="sidebar-icon">
                <span class="sidebar-text">Изменить пароль</span>
            </a>
        </li>
        <% if (typeof user !== 'undefined' && user && user.role === 'superadmin') { %>
        <li>
            <a href="<%= baseUrl %>/admin" class="sidebar-link">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%235d6d7e'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z'/%3E%3C/svg%3E" class="sidebar-icon">
                <span class="sidebar-text">Админ панель</span>
            </a>
        </li>
        <% } %>
        
        <% if (!isSyncing) { %>
        <li>
            <a href="#" class="sidebar-link" onclick="startSync(event)">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%235d6d7e'%3E%3Cpath d='M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z'/%3E%3C/svg%3E" class="sidebar-icon">
                <span class="sidebar-text">Обновить данные</span>
            </a>
        </li>
        <% } %>
    </ul>

    <% if (isSyncing) { %>
        <div class="sync-indicator">
            <div class="spinner"></div>
            <span class="sync-text">Синхронизация...</span>
        </div>
    <% } %>

    <div class="sidebar-footer">
        <a href="<%= baseUrl %>/logout" class="sidebar-link">
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%235d6d7e'%3E%3Cpath d='M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z'/%3E%3C/svg%3E" class="sidebar-icon">
            <span class="sidebar-text">Выход</span>
        </a>
        <button class="sidebar-toggle-btn" id="sidebarToggle">
            <div class="sidebar-toggle-icon"></div>
            <span class="sidebar-text">Свернуть</span>
        </button>
    </div>
</div>

<div id="passwordModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 20px; border-radius: 8px; width: 300px;">
        <h3 style="margin-top: 0;">Смена пароля</h3>
        <input type="password" id="newPassword" placeholder="Новый пароль" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button onclick="closePasswordModal()" style="padding: 5px 10px; cursor: pointer; border: none; background: #eee; border-radius: 4px;">Отмена</button>
            <button onclick="saveNewPassword()" style="padding: 5px 10px; cursor: pointer; border: none; background: #27ae60; color: white; border-radius: 4px;">Сохранить</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const sidebar = document.getElementById('sidebar');
        const contentWrapper = document.getElementById('contentWrapper');
        const toggleBtn = document.getElementById('sidebarToggle');
        
        const sidebarState = localStorage.getItem('sidebarState');
        if (sidebarState === 'collapsed') {
            sidebar.classList.add('collapsed');
            if(contentWrapper) contentWrapper.classList.add('expanded');
        }

        if(toggleBtn) {
            toggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                if(contentWrapper) contentWrapper.classList.toggle('expanded');
                localStorage.setItem('sidebarState', sidebar.classList.contains('collapsed') ? 'collapsed' : 'expanded');

                setTimeout(() => {
                    window.dispatchEvent(new Event('resize'));
                }, 300);
            });
        }
    });

    async function startSync(e) {
        e.preventDefault();
        if(!confirm('Запустить обновление данных с FTP? Это может занять время.')) return;
        
        try {
            const res = await fetch('<%= baseUrl %>/api/sync/start', { method: 'POST' });
            const data = await res.json();
            if(data.success) {
                window.location.reload();
            } else {
                alert(data.message || 'Ошибка запуска');
            }
        } catch(e) {
            alert('Ошибка соединения');
        }
    }

    function openPasswordModal(e) {
        e.preventDefault();
        document.getElementById('passwordModal').style.display = 'flex';
    }
    function closePasswordModal() {
        document.getElementById('passwordModal').style.display = 'none';
    }
    async function saveNewPassword() {
        const newPass = document.getElementById('newPassword').value;
        if (!newPass) return;
        try {
            const res = await fetch('<%= baseUrl %>/api/change-password', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({newPassword: newPass})
            });
            const data = await res.json();
            if(data.success) {
                alert('Пароль изменен');
                closePasswordModal();
            } else {
                alert('Ошибка при смене пароля');
            }
        } catch(e) {
            alert('Ошибка сети');
        }
    }
</script>