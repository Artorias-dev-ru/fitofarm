<!DOCTYPE html>
<html>
<head>
    <title>Детали адреса</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="<%= baseUrl %>/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .dialog-sidebar {
            height: calc(100vh - 250px);
            overflow-y: auto;
            position: relative;
        }
        .date-separator {
            position: sticky;
            top: 0;
            background: #f4f6f8;
            z-index: 10;
            padding: 10px;
            font-size: 11px;
            font-weight: 700;
            color: #999;
            border-bottom: 1px solid #eee;
            text-transform: uppercase;
        }
        .status-button {
            border-radius: 4px;
            padding: 5px 10px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: #000;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            user-select: none;
            text-align: center;
            display: inline-block;
            transition: background 0.1s;
            width: 124px;
            z-index: 2;
            position: relative;
            background: white;
            margin-right: 3px;
        }
        .status-button:active {
            background: #e0e0e0;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        .status-dropdown-wrapper {
            position: relative;
            display: inline-block;
            margin-right: 15px;
        }
        .status-menu {
            display: none;
            position: absolute;
            right: 0;
            background: #e1e7ed;
            border: 1px solid #b0b0b0;
            border-radius: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            min-width: 130px;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            text-align: center;
            padding: 40px 0 0 0;
            top: -5px;
            z-index: 1;
        }
        .status-option {
            padding: 2px 0;
            font-size: 13px;
            color: #000;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.1s;
        }
        .status-option:hover {
            background: #dceefc;
            border: 1px solid #a8d8eb;
            margin: -1px; 
            position: relative;
            z-index: 1;
        }
        .action-icon {
            width: 18px;
            height: 18px; 
            cursor: pointer; 
            opacity: 0.5; 
            transition: opacity 0.2s;
        }
        .action-icon:hover {
            opacity: 1;
        }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            cursor: pointer;
            height: 20px;
        }
        input[type="range"]:focus { outline: none; }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #e0e0e0; border-radius: 2px;
        }
        input[type="range"]::-webkit-slider-thumb {
            height: 12px; width: 12px; border-radius: 50%; background: #333;
            cursor: pointer; -webkit-appearance: none; margin-top: -4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .tabs-container { display: flex; gap: 10px; margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .tab-btn { background: none; border: none; padding: 5px 10px; cursor: pointer; font-family: 'Inter'; font-size: 14px; color: #999; font-weight: 500; position: relative; }
        .tab-btn.active { color: #333; }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -11px; left: 0; width: 100%; height: 2px; background: #333; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .save-btn { background: #333; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: 600; font-family: 'Inter'; width: 100%; }
    </style>
</head>
<body>
    <%- include('sidebar') %>
    <div class="content-wrapper" id="contentWrapper">
        <div class="header-container"></div>
        <div class="details-container">
            <div class="object-header">
                <div class="object-title-box">
                    <div class="object-label">Адрес</div>
                    <div class="object-city"><%= item.city %></div>
                    <div class="object-address"><%= item.address %></div>
                </div>
                <div class="header-stats">
                    <div class="stats-group">
                        <span class="stats-label">Продажа</span>
                        <a href="<%= baseUrl %>/details/<%= item.id %>?type=sales" class="stat-card sales"><%= item.sales %></a>
                    </div>
                    <div class="stats-group">
                        <span class="stats-label">Отказы</span>
                        <a href="<%= baseUrl %>/details/<%= item.id %>?type=refusals" class="stat-card refusals"><%= item.refusals %></a>
                    </div>
                    <div class="stats-group">
                        <span class="stats-label">Итого</span>
                        <a href="<%= baseUrl %>/details/<%= item.id %>" class="stat-card total"><%= item.sales + item.refusals + item.unknown %></a>
                    </div>
                </div>
            </div>
            <div class="details-grid">
                <div class="dialog-sidebar">
                    <% if(dialogues.length === 0) { %>
                        <div style="color: #999; text-align: center; margin-top: 20px;">Нет диалогов</div>
                    <% } %>
                    <% 
                    let lastDate = null;
                    function formatDate(dateStr) {
                        if (!dateStr) return '';
                        const parts = dateStr.split('-');
                        if (parts.length === 3) return `${parts[2]}.${parts[1]}.${parts[0]}`;
                        return dateStr;
                    }
                    %>
                    <% dialogues.forEach((dialog, index) => { %>
                        <% if (dialog.date !== lastDate) { %>
                            <div class="date-separator"><%= formatDate(dialog.date) %></div>
                            <% lastDate = dialog.date; %>
                        <% } %>
                        <a href="<%= baseUrl %>/details/<%= item.id %>?type=<%= activeType %>&dialogId=<%= dialog.id %>&tab=<%= activeTab %>" class="dialog-card <%= (activeDialog && activeDialog.id === dialog.id) ? 'active' : '' %> <%= dialog.status %>" style="text-decoration: none;">
                            <span>Диалог <%= index + 1 %></span>
                            <% if (dialog.startTime && dialog.startTime !== '00:00') { %>
                                <span style="font-size: 11px; color: #999; margin-left: auto; margin-right: 5px;"><%= dialog.startTime %></span>
                            <% } %>
                            <img src="<%= baseUrl %>/icons/download.svg" class="download-icon" style="width: 16px; opacity: 0.5;"> 
                        </a>
                    <% }) %>
                </div>
                <div class="transcript-area">
                    <% if (activeDialog) { %>
                        <div style="margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center;">
                                <span style="font-weight: 700; font-size: 16px;">Диалог <%= dialogues.findIndex(d => d.id === activeDialog.id) + 1 %></span>
                                <span style="color: #999; font-size: 13px; margin-left: 10px;">(<%= activeDialog.status === 'sales' ? 'Продажа' : activeDialog.status === 'refusals' ? 'Отказ' : 'Нераспознан' %>)</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <div class="status-dropdown-wrapper">
                                    <div class="status-button" onclick="toggleStatusMenu(event)">Итог диалога</div>
                                    <div id="status-menu" class="status-menu">
                                        <div class="status-option" onclick="changeStatus('<%= activeDialog.id %>', 'sales')">Продажа</div>
                                        <div class="status-option" onclick="changeStatus('<%= activeDialog.id %>', 'refusals')">Отказ</div>
                                        <div class="status-option" onclick="changeStatus('<%= activeDialog.id %>', 'unknown')">Нераспознан</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px; opacity: 0.5;">
                                    <img src="<%= baseUrl %>/icons/copy.svg" class="action-icon" alt="Копировать" style="opacity: 1;">
                                    <img src="<%= baseUrl %>/icons/download.svg" class="action-icon" alt="Скачать" style="opacity: 1;">
                                </div>
                            </div>
                        </div>
                        <% if (activeDialog.transcribedText) { %>
                            <div style="display: flex; height: 90%; gap: 20px;">
                                <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; border-right: 1px solid #eee; padding-right: 10px;">
                                    <div style="font-weight: 600; margin-bottom: 10px; color: #555;">Исходный (Output)</div>
                                    <div style="overflow-y: auto; flex: 1;"><pre style="white-space: pre-wrap; font-family: 'Inter', sans-serif; color: #444; font-size: 14px;"><%= activeDialog.text %></pre></div>
                                </div>
                                <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                                    <div style="font-weight: 600; margin-bottom: 10px; color: #555;">Распознанный (LLM)</div>
                                    <div style="overflow-y: auto; flex: 1;"><pre style="white-space: pre-wrap; font-family: 'Inter', sans-serif; color: #444; font-size: 14px;"><%= activeDialog.transcribedText %></pre></div>
                                </div>
                            </div>
                        <% } else { %>
                            <div style="overflow-y: auto; height: 90%;"><pre style="white-space: pre-wrap; font-family: 'Inter', sans-serif; color: #444; font-size: 14px;"><%= activeDialog.text %></pre></div>
                        <% } %>
                    <% } else { %>
                        <div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #999;">Выберите диалог из списка слева</div>
                    <% } %>
                </div>
                <div class="actions-sidebar">
                    <div class="audio-player-mock <%= (!activeDialog || !activeDialog.audioUrl) ? 'player-disabled' : '' %>">
                        <% if (activeDialog && activeDialog.audioUrl) { %>
                            <audio id="main-audio" src="<%= baseUrl %>/api/audio/<%= activeDialog.id %>"></audio>
                        <% } %>
                        <div class="player-controls">
                            <div class="play-btn" onclick="toggleAudio()"><img id="play-icon" src="<%= baseUrl %>/icons/play.svg" style="width: 25px; filter: invert(1);"></div>
                            <div style="font-size: 12px; font-weight: 600; min-width: 80px;"><span id="current-time">0:00</span> / <span id="duration">0:00</span></div>
                            <div class="volume-control"><input type="range" id="volume-slider" min="0" max="1" step="0.05" value="1"></div>
                        </div>
                        <input type="range" id="seek-slider" max="100" value="0">
                    </div>
                    <div class="tabs-container">
                        <button class="tab-btn <%= activeTab === 'summary' ? 'active' : '' %>" onclick="openTab('summary')">Краткий отчет</button>
                        <button class="tab-btn <%= activeTab === 'notes' ? 'active' : '' %>" onclick="openTab('notes')">Заметки</button>
                    </div>
                    <div class="report-body">
                        <div id="tab-summary" class="tab-content <%= activeTab === 'summary' ? 'active' : '' %>">
                            <% if (activeDialog) { %>
                                <p style="margin-top: 0;"><strong>Краткое содержание:</strong></p>
                                <p style="line-height: 1.6; color: #555; white-space: pre-wrap;"><%= activeDialog.summary %></p>
                            <% } else { %><p style="color:#999">...</p><% } %>
                        </div>
                        <div id="tab-notes" class="tab-content <%= activeTab === 'notes' ? 'active' : '' %>">
                            <% if (activeDialog) { %>
                                <div style="margin-bottom: 20px;">
                                    <textarea id="note-textarea" placeholder="Напишите новую заметку..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; font-family: 'Inter', sans-serif;"></textarea>
                                    <button class="save-btn" onclick="saveNote(<%= activeDialog.id %>)">Добавить заметку</button>
                                </div>
                                <div class="notes-history" style="border-top: 1px solid #eee; padding-top: 20px;">
                                    <% if (activeDialog.notes && activeDialog.notes.length > 0) { %>
                                        <% activeDialog.notes.forEach(note => { %>
                                            <div style="background: #f9f9f9; padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #eee;">
                                                <div style="font-size: 11px; color: #999; margin-bottom: 6px;"><%= new Date(note.createdAt).toLocaleString('ru-RU') %></div>
                                                <div style="font-size: 13px; color: #333; line-height: 1.4; white-space: pre-wrap;"><%= note.content %></div>
                                            </div>
                                        <% }) %>
                                    <% } else { %><div style="color: #ccc; text-align: center; font-size: 13px;">Нет заметок</div><% } %>
                                </div>
                            <% } else { %><p style="color:#999">Выберите диалог</p><% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const audio = document.getElementById('main-audio');
        const playIcon = document.getElementById('play-icon');
        const seekSlider = document.getElementById('seek-slider');
        const volumeSlider = document.getElementById('volume-slider');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        let isDragging = false;
        function formatTime(s) { if (!s || isNaN(s)) return "0:00"; const m = Math.floor(s/60); const sec = Math.floor(s%60); return `${m}:${sec<10?'0':''}${sec}`; }
        function updateSliderBackground(s) {
            const v = s.value; const min = s.min || 0; const max = s.max || 100; const p = (v-min)/(max-min)*100;
            s.style.background = `linear-gradient(to right, #333 0%, #333 ${p}%, #e0e0e0 ${p}%, #e0e0e0 100%)`;
            s.style.backgroundSize = '100% 4px'; s.style.backgroundRepeat = 'no-repeat'; s.style.backgroundPosition = 'center';
        }
        if (audio) {
            audio.addEventListener('loadedmetadata', () => { durationEl.innerText = formatTime(audio.duration); if(seekSlider) seekSlider.max = Math.floor(audio.duration); updateSliderBackground(seekSlider); updateSliderBackground(volumeSlider); });
            audio.addEventListener('timeupdate', () => { if (!isDragging) { if(seekSlider) seekSlider.value = Math.floor(audio.currentTime); currentTimeEl.innerText = formatTime(audio.currentTime); updateSliderBackground(seekSlider); } });
            audio.addEventListener('ended', () => { playIcon.src = "<%= baseUrl %>/icons/play.svg"; if(seekSlider) seekSlider.value = 0; updateSliderBackground(seekSlider); });
            if(seekSlider) {
                seekSlider.addEventListener('input', () => { isDragging = true; currentTimeEl.innerText = formatTime(seekSlider.value); updateSliderBackground(seekSlider); });
                seekSlider.addEventListener('change', () => { audio.currentTime = seekSlider.value; isDragging = false; });
            }
            if(volumeSlider) volumeSlider.addEventListener('input', (e) => { audio.volume = e.target.value; updateSliderBackground(volumeSlider); });
        }
        function toggleAudio() { if(!audio) return; if(audio.paused) audio.play().then(()=>playIcon.src="<%= baseUrl %>/icons/pause.svg"); else { audio.pause(); playIcon.src="<%= baseUrl %>/icons/play.svg"; } }
        function toggleStatusMenu(e) { e.stopPropagation(); const m = document.getElementById('status-menu'); m.style.display = m.style.display==='block'?'none':'block'; }
        document.addEventListener('click', () => { const m = document.getElementById('status-menu'); if(m) m.style.display = 'none'; });
        async function changeStatus(id, s) { try { const r = await fetch('<%= baseUrl %>/api/update-status', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ dialogId: id, status: s }) }); if(r.ok) window.location.reload(); } catch(e) { alert('Ошибка'); } }
        function openTab(t) { document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); const u = new URL(window.location.href); u.searchParams.set('tab', t); window.history.replaceState({}, '', u); }
        async function saveNote(id) {
            const txt = document.getElementById('note-textarea').value; if(!txt.trim()) return;
            try { const r = await fetch('<%= baseUrl %>/api/save-note', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ dialogId: id, note: txt }) }); if(r.ok) { const u = new URL(window.location.href); u.searchParams.set('tab', 'notes'); window.location.href = u.toString(); } } catch(e) {}
        }
        document.addEventListener('DOMContentLoaded', () => {
            const activeCard = document.querySelector('.dialog-card.active');
            if (activeCard) activeCard.scrollIntoView({ behavior: 'auto', block: 'center' });
        });
    </script>
</body>
</html>